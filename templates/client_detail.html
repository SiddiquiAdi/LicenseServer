{% extends "base.html" %}
{% block title %}{{ client.name }} - Client Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-building"></i> {{ client.name }}</h2>
            <p class="text-muted mb-0">Client ID: #{{ client.id }}</p>
        </div>
        <div>
            <a href="{{ url_for('clients_list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Clients
            </a>
            <button class="btn btn-warning" onclick="editClient({{ client.id }}, '{{ client.name|replace("'", "\\'") }}', '{{ client.contact_person|default('')|replace("'", "\\'") }}', '{{ client.email|default('') }}', '{{ client.phone|default('') }}', '{{ client.address|default('')|replace("'", "\\'")|replace('\n', '\\n') }}', '{{ client.gst_number|default('') }}', '{{ client.status }}', '{{ client.notes|default('')|replace("'", "\\'")|replace('\n', '\\n') }}')">
                <i class="fas fa-edit"></i> Edit
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <i class="fas fa-key fa-2x text-primary mb-2"></i>
                    <h3 class="text-primary">{{ total_licenses }}</h3>
                    <p class="text-muted mb-0">Total Licenses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h3 class="text-success">{{ active_licenses }}</h3>
                    <p class="text-muted mb-0">Active Licenses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-warning mb-2"></i>
                    <h3 class="text-warning">{{ total_users }}</h3>
                    <p class="text-muted mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="fas fa-laptop fa-2x text-info mb-2"></i>
                    <h3 class="text-info">{{ total_devices }}</h3>
                    <p class="text-muted mb-0">Active Devices</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Info + Status -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Client Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <th width="30%"><i class="fas fa-building text-muted"></i> Company Name:</th>
                            <td><strong>{{ client.name }}</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-user text-muted"></i> Contact Person:</th>
                            <td>{{ client.contact_person or '-' }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-envelope text-muted"></i> Email:</th>
                            <td>
                                {% if client.email %}
                                <a href="mailto:{{ client.email }}">{{ client.email }}</a>
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-phone text-muted"></i> Phone:</th>
                            <td>
                                {% if client.phone %}
                                <a href="tel:{{ client.phone }}">{{ client.phone }}</a>
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-file-invoice text-muted"></i> GST / Tax ID:</th>
                            <td>{{ client.gst_number or '-' }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-map-marker-alt text-muted"></i> Address:</th>
                            <td>{{ client.address or '-' }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar text-muted"></i> Created:</th>
                            <td>{{ client.created_at.strftime('%B %d, %Y at %I:%M %p') }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-toggle-on text-muted"></i> Status:</th>
                            <td>
                                {% if client.status == 'active' %}
                                <span class="badge bg-success px-3 py-2">Active</span>
                                {% else %}
                                <span class="badge bg-secondary px-3 py-2">Inactive</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                    {% if client.notes %}
                    <div class="alert alert-info mt-3">
                        <strong><i class="fas fa-sticky-note"></i> Notes:</strong><br>
                        {{ client.notes }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Quick Stats</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Active Licenses</span>
                            <strong>{{ active_licenses }} / {{ total_licenses }}</strong>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: {{ (active_licenses / total_licenses * 100)|int if total_licenses > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Expired Licenses</span>
                            <strong class="text-danger">{{ expired_licenses }}</strong>
                        </div>
                        {% if expired_licenses > 0 %}
                        <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Action required</small>
                        {% else %}
                        <small class="text-success"><i class="fas fa-check"></i> All licenses valid</small>
                        {% endif %}
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('licenses_list') }}?client={{ client.id }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-key"></i> View All Licenses
                        </a>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addLicenseModal">
                            <i class="fas fa-plus"></i> Add New License
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Licenses Table -->
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-key"></i> Licenses ({{ licenses|length }})</h5>
        </div>
        <div class="card-body p-0">
            {% if licenses %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>License Key</th>
                            <th>Plan Type</th>
                            <th>Users</th>
                            <th>Devices</th>
                            <th>Activation Date</th>
                            <th>Expiry Date</th>
                            <th>Days Left</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lic in licenses %}
                        {% set days_left = ((lic.expiry_date - now).days if lic.expiry_date > now else 0) %}
                        <tr>
                            <td><code class="text-primary">{{ lic.license_key }}</code></td>
                            <td><span class="badge bg-primary">{{ lic.plan_type }}</span></td>
                            <td>{{ lic.users|length }} / {{ lic.max_users }}</td>
                            <td>{{ lic.devices|selectattr('is_active')|list|length }} / {{ lic.max_devices }}</td>
                            <td>{{ lic.activation_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ lic.expiry_date.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if days_left > 0 %}
                                <span class="badge {% if days_left < 7 %}bg-danger{% elif days_left < 30 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                    {{ days_left }} days
                                </span>
                                {% else %}
                                <span class="badge bg-danger">Expired</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if lic.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-key fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No Licenses Yet</h5>
                <p class="text-muted">This client doesn't have any licenses assigned.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLicenseModal">
                    <i class="fas fa-plus"></i> Create First License
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Include Edit Modal (reuse from clients.html) -->
<div class="modal fade" id="editClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editClientForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" id="edit_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Person</label>
                            <input type="text" class="form-control" name="contact_person" id="edit_contact_person">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="edit_email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone" id="edit_phone">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">GST / Tax ID</label>
                            <input type="text" class="form-control" name="gst_number" id="edit_gst_number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" id="edit_status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" id="edit_address" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" id="edit_notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Client</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editClient(id, name, contact, email, phone, address, gst, status, notes) {
    document.getElementById('editClientForm').action = `/admin/clients/edit/${id}`;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_contact_person').value = contact;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_phone').value = phone;
    document.getElementById('edit_address').value = address;
    document.getElementById('edit_gst_number').value = gst;
    document.getElementById('edit_status').value = status;
    document.getElementById('edit_notes').value = notes;
    
    new bootstrap.Modal(document.getElementById('editClientModal')).show();
}
</script>
{% endblock %}
